# 포트폴리오 스크린샷 분석 및 자동화 리포트 기능 명세서

## 1. 개요 (Overview)
사용자가 주식 계좌 스크린샷을 업로드하면, AI가 이를 분석하여 포트폴리오를 디지털화하고, 실시간 시세 추적 대시보드를 생성하며, 심층 분석 리포트를 PDF로 생성해 이메일로 발송하는 기능입니다.

---

## 2. 프로세스 플로우 (Process Flow)
1.  **Upload**: 사용자가 채팅창에 포트폴리오 스크린샷 드래그 & 드롭.
2.  **Analyze (Vision AI)**: GPT-4o Vision API가 이미지를 분석하여 **JSON 데이터**로 구조화 (종목코드, 수량, 평단가, 수익률 등 추출).
3.  **Store**: 추출된 데이터를 DB (`portfolios`, `holdings`)에 저장.
4.  **Visualize (Dashboard)**:
    *   홈 화면이 **"채팅 모드"**에서 **"대시보드 모드"**로 전환 (또는 하단에 섹션 추가).
    *   **Donut Chart**: 자산 배분 현황 시각화.
    *   **Real-time Ticker**: `yfinance`를 연동하여 현재가 업데이트 및 등락률 표시.
5.  **Report & Email**:
    *   포트폴리오 리스크 및 배당 분석 수행.
    *   PDF 리포트 생성 (`ReportLab` 등 활용).
    *   사용자 이메일로 자동 발송.

---

## 3. 기능 상세 및 수정 제안 (Refinements)

### 3.1. 이미지 파싱 및 데이터 구조화 (Image to JSON)
*   **아이디어 구체화**: 단순 종목명만 뽑는 것이 아니라, **티커(Ticker)**로 변환하는 것이 핵심입니다. (예: "삼성전자" -> `005930.KS`, "Apple" -> `AAPL`).
*   **보완점**: 스크린샷에 수량/평단가가 없는 경우(단순 관심종목 리스트 등)를 대비해, UI에서 사용자에게 "수정 및 확정" 단계를 거치게 해야 정확도가 보장됩니다.

### 3.2. 실시간 주가 추적 (Real-time Tracking)
*   **API 현실성**: 실제 초단위 실시간 데이터는 유료(High Cost)입니다.
*   **대안**: `yfinance` 라이브러리를 사용하여 **1~5분 단위 폴링** 혹은 **새로고침 시 업데이트** 방식으로 구현하는 것이 현실적입니다. (MVP 단계)
*   **백엔드**: FastAPI `BackgroundTasks`를 이용해 주기적으로 시세를 업데이트하는 로직이 필요합니다.

### 3.3. UI/UX: 포트폴리오 대시보드
*   **위치**: 채팅창은 유지하되, 이미지가 업로드되면 채팅창 아래에 **"분석된 포트폴리오 카드"**가 생기거나, 별도의 **'/dashboard'** 페이지로 이동시키는 것을 추천합니다. 홈 화면에 너무 많은 정보가 섞이면 복잡해질 수 있습니다.
*   **디자인**:
    *   **도넛 차트 (Donut Chart)**: 섹터별(기술, 금융, 소비재 등) 비중 시각화.
    *   **종목 리스트**: 토스증권처럼 로고와 함께 등락률 색상 코딩 (빨강/파랑).

### 3.4. PDF 리포트 및 이메일
*   **PDF 콘텐츠**:
    *   **자산 배분 차트**: 이미지로 생성하여 PDF 삽입.
    *   **AI 코멘트**: "기술주 비중이 70%로 매우 높습니다. 금리 인상 시기에 리스크가..." 등의 텍스트 생성.
    *   **배당 캘린더**: 예상 배당금 지급일.
*   **기술 스택**: Python `weasyprint` 또는 `reportlab` 사용. 이메일은 `FastAPI-Mail` 사용.

---

## 4. 데이터베이스 스키마 설계 (DB Schema)

### `portfolios` 테이블
*   `id`: PK
*   `user_id`: FK
*   `created_at`: 생성일
*   `total_value`: 총 자산 가치
*   `risk_score`: AI가 판단한 리스크 점수

### `portfolio_items` 테이블
*   `id`: PK
*   `portfolio_id`: FK
*   `ticker`: 종목 코드 (예: AAPL)
*   `name`: 종목명
*   `shares`: 보유 수량
*   `avg_price`: 평단가
*   `current_price`: 현재가 (주기적 업데이트)
*   `sector`: 섹터 (예: Technology)

---

## 5. 구현 단계 (Implementation Steps)

### Phase 1: 파싱 및 저장 (Backend)
1.  [x] `RAGChat`에서 이미지 수신부 구현.
2.  [x] OpenAI Vision API 프롬프트 작성 (JSON 스키마 정의).
3.  [x] DB 모델링 (`Portfolios`, `PortfolioItems`) 및 마이그레이션.
4.  [x] 파싱 결과를 DB에 저장하는 로직 구현.

### Phase 2: 대시보드 시각화 (Frontend)
1.  [x] `Recharts` 라이브러리 설치.
2.  [x] 포트폴리오 도넛 차트 컴포넌트 개발.
3.  [x] 실시간 가격 표시 리스트 컴포넌트 개발.

### Phase 3: 가격 추적 로직
1.  [x] `yfinance` 연동하여 현재가 가져오는 유틸리티 함수 작성.
2.  [x] 포트폴리오 조회 API 작성 (`GET /portfolio`).

### Phase 4: 리포트 및 이메일
1.  [ ] PDF 생성 템플릿 디자인 (HTML/CSS 이용 -> PDF 변환).
2.  [ ] 이메일 발송 설정 (SMTP).
3.  [ ] "리포트 받아보기" 버튼 기능 구현.
